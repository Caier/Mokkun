"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_js_1 = require("discord.js");
const ytdl_core_discord_1 = __importDefault(require("ytdl-core-discord"));
const yts_1 = __importDefault(require("@caier/yts"));
const v4_1 = __importDefault(require("uuid/v4"));
const sc_1 = __importDefault(require("@caier/sc"));
class MusicEntry {
    constructor(opts) {
        this.id = v4_1.default();
        this.addedOn = Date.now();
        this.addedBy = opts.member;
        this.queue = opts.queue;
        this.type = opts.type;
        this.videoInfo = opts.vid;
    }
    get strTime() {
        var _a, _b;
        return (_b = (_a = this.dispatcher) === null || _a === void 0 ? void 0 : _a.streamTime) !== null && _b !== void 0 ? _b : 0;
    }
    get milisLeft() {
        return this.videoInfo.milis - this.strTime;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
}
exports.MusicEntry = MusicEntry;
class MusicQueue {
    constructor() {
        this.queue = [];
        this.history = [];
        this.playing = null;
    }
    addEntry(entry, VoiceC, top) {
        this.VoiceCon = VoiceC;
        if (top)
            this.queue.unshift(entry);
        else
            this.queue.push(entry);
        if (!this.playing)
            this._playNext();
        else
            this._announce('addedToQueue', entry);
    }
    _playNext() {
        if (this.queue.length > 0) {
            if (this.playing)
                this.history.push(this.playing);
            this.playing = this.queue.shift();
            this.play(this.playing);
            this._announce('nextSong');
        }
        else
            this._finish();
    }
    async play(entry) {
        var _a, _b;
        if (this.VoiceCon.status != '0')
            throw Error('VoiceConnection is not ready');
        let str;
        if (entry.type == 'yt')
            str = await MokkunMusic.getYTStream(entry.videoInfo.url);
        else if (entry.type == 'sc')
            str = await sc_1.default.download(entry.videoInfo.id);
        str.on('end', () => setTimeout(() => this._playNext(), 2000));
        this.playing.dispatcher = this.VoiceCon.play(str, { type: 'opus', highWaterMark: 1 });
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.setFEC(true);
    }
    _finish() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause) === null || _c === void 0 ? void 0 : _c.call(_b);
        if (this.playing)
            this.history.push(this.playing);
        this.playing = null;
        this.destTimer = setTimeout(() => {
            if (!this.playing)
                this.VoiceCon.disconnect();
        }, 600000);
    }
    set destTimer(timer) {
        this.timer && clearTimeout(this.timer);
        this.timer = timer;
    }
    _announce(what, entry, ret) {
        var _a, _b;
        if (!this.outChannel)
            throw Error('Announement channel is not specified');
        let embed = new discord_js_1.MessageEmbed().setColor((entry === null || entry === void 0 ? void 0 : entry.type) == 'sc' ? '#ff8800' : [112, 0, 55]);
        if (what == 'nextSong') {
            let pl = this.playing;
            embed.setAuthor('NastÄ™pny utwÃ³r ðŸŽµ')
                .setColor((pl === null || pl === void 0 ? void 0 : pl.type) == 'sc' ? '#ff8800' : [112, 0, 55])
                .setDescription(`**[${pl.videoInfo.name}](${pl.videoInfo.url})**`)
                .setThumbnail(pl.videoInfo.thumbnail)
                .addField("KanaÅ‚", pl.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", pl.videoInfo.duration, true)
                .addField("Dodano przez", pl.addedBy.user.username, true)
                .addField("NastÄ™pnie", (_b = (_a = this.queue[0]) === null || _a === void 0 ? void 0 : _a.videoInfo.name) !== null && _b !== void 0 ? _b : 'brak');
        }
        else if (what == 'addedToQueue') {
            let entry = arguments[1];
            embed.setAuthor('Dodano do kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail)
                .addField("KanaÅ‚", entry.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", entry.videoInfo.duration, true)
                .addField("Za", this.timeLeft, true)
                .addField("Pozycja", this.queue.findIndex(v => v.id == entry.id) + 1);
        }
        else if (what == 'removed') {
            let entry = arguments[1];
            embed.setAuthor('UsuniÄ™to z kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail);
        }
        if (ret)
            return embed;
        this.outChannel.send(embed);
    }
    get milisLeft() {
        var _a, _b;
        let len = (((_a = this.playing) === null || _a === void 0 ? void 0 : _a.videoInfo.milis) || 0) - (((_b = this.playing) === null || _b === void 0 ? void 0 : _b.strTime) || 0);
        for (let ent of this.queue.slice(0, -1))
            len += ent.videoInfo.milis;
        return len;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
    pause() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause();
    }
    resume() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.resume();
    }
    remove(pos) {
        if (!(/^[1-9]\d*$/).test(pos) || !this.queue[+pos - 1]) {
            return false;
        }
        this._announce('removed', this.queue.splice(+pos - 1, 1)[0]);
        return true;
    }
    setOutChan(chan) {
        this.outChannel = chan;
        return this;
    }
    get status() {
        var _a, _b, _c;
        return ((_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.paused) ? 'paused' : ((_c = this.playing) === null || _c === void 0 ? void 0 : _c.dispatcher) ? 'playing' : 'idle';
    }
}
exports.MusicQueue = MusicQueue;
class MokkunMusic {
    constructor() {
        this.queues = new discord_js_1.Collection();
        sc_1.default.setClientId(process.env.SC_CLIENT_ID);
    }
    getQueue(guild) {
        let q = this.queues.get(guild.id);
        if (!q) {
            q = new MusicQueue();
            this.queues.set(guild.id, q);
        }
        return q;
    }
    searchVideos(query) {
        return yts_1.default(query);
    }
    searchSC(query) {
        return sc_1.default.search(query);
    }
    static getYTStream(url) {
        return ytdl_core_discord_1.default(url, { quality: 'highestaudio', highWaterMark: 1 << 25 });
    }
    destroyQueue(guildid) {
        this.queues.delete(guildid);
    }
}
exports.MokkunMusic = MokkunMusic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9ra3VuTXVzaWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvTW9ra3VuTXVzaWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FBeUc7QUFHekcsMEVBQXFDO0FBQ3JDLHFEQUE2QjtBQUU3QixpREFBMkI7QUFDM0IsbURBQTJCO0FBRzNCLE1BQWEsVUFBVTtJQVNuQixZQUFZLElBQTRGO1FBUnhHLE9BQUUsR0FBVyxZQUFJLEVBQUUsQ0FBQztRQUNwQixZQUFPLEdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBUXpCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUM5QixDQUFDO0lBRUQsSUFBSSxPQUFPOztRQUNQLG1CQUFPLElBQUksQ0FBQyxVQUFVLDBDQUFFLFVBQVUsbUNBQUksQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxJQUFJLFNBQVM7UUFDVCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDL0MsQ0FBQztJQUVELElBQUksUUFBUTtRQUNSLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7Q0FDSjtBQTNCRCxnQ0EyQkM7QUFFRCxNQUFhLFVBQVU7SUFBdkI7UUFFSSxVQUFLLEdBQWlCLEVBQUUsQ0FBQztRQUN6QixZQUFPLEdBQWlCLEVBQUUs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QUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNoQztRQUNELE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQztJQUVELFlBQVksQ0FBQyxLQUFhO1FBQ3RCLE9BQU8sYUFBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxRQUFRLENBQUMsS0FBYTtRQUNsQixPQUFPLFlBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBVztRQUMxQixPQUFPLDJCQUFJLENBQUMsR0FBRyxFQUFFLEVBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsQ0FBQyxJQUFFLEVBQUUsRUFBQyxDQUFDLENBQUM7SUFDdEUsQ0FBQztJQUVELFlBQVksQ0FBQyxPQUFlO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDSjtBQS9CRCxrQ0ErQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2xsZWN0aW9uLCBUZXh0Q2hhbm5lbCwgTWVzc2FnZUVtYmVkLCBHdWlsZCwgR3VpbGRNZW1iZXIsIFN0cmVhbURpc3BhdGNoZXIgfSBmcm9tICdkaXNjb3JkLmpzJztcclxuLy8gQHRzLWlnbm9yZVxyXG5pbXBvcnQgVm9pY2VDb25uZWN0aW9uIGZyb20gJ2Rpc2NvcmQuanMvc3JjL2NsaWVudC92b2ljZS9Wb2ljZUNvbm5lY3Rpb24nO1xyXG5pbXBvcnQgeXRkbCBmcm9tICd5dGRsLWNvcmUtZGlzY29yZCc7XHJcbmltcG9ydCB5dHMgZnJvbSAnQGNhaWVyL3l0cyc7XHJcbmltcG9ydCB7IFZpZGVvRW50cnkgfSBmcm9tICdAY2FpZXIveXRzL2xpYi9pbnRlcmZhY2VzJztcclxuaW1wb3J0IHV1aWQgZnJvbSAndXVpZC92NCc7XHJcbmltcG9ydCBzYyBmcm9tICdAY2FpZXIvc2MnO1xyXG5pbXBvcnQgeyBTb25nRW50cnkgfSBmcm9tICdAY2FpZXIvc2Mvb3V0L2ludGVyZmFjZXMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE11c2ljRW50cnkge1xyXG4gICAgaWQ6IHN0cmluZyA9IHV1aWQoKTtcclxuICAgIGFkZGVkT246IG51bWJlciA9IERhdGUubm93KCk7XHJcbiAgICBhZGRlZEJ5OiBHdWlsZE1lbWJlcjtcclxuICAgIHF1ZXVlOiBNdXNpY1F1ZXVlO1xyXG4gICAgdHlwZTogXCJ5dFwifFwic2NcIjtcclxuICAgIHZpZGVvSW5mbzogVmlkZW9FbnRyeSB8IFNvbmdFbnRyeTtcclxuICAgIGRpc3BhdGNoZXI/OiBTdHJlYW1EaXNwYXRjaGVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdHM6IHt2aWQ6IFZpZGVvRW50cnkgfCBTb25nRW50cnksIG1lbWJlcjogR3VpbGRNZW1iZXIsIHF1ZXVlOiBNdXNpY1F1ZXVlLCB0eXBlOiBcInl0XCJ8XCJzY1wifSkge1xyXG4gICAgICAgIHRoaXMuYWRkZWRCeSA9IG9wdHMubWVtYmVyO1xyXG4gICAgICAgIHRoaXMucXVldWUgPSBvcHRzLnF1ZXVlO1xyXG4gICAgICAgIHRoaXMudHlwZSA9IG9wdHMudHlwZTtcclxuICAgICAgICB0aGlzLnZpZGVvSW5mbyA9IG9wdHMudmlkO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBnZXQgc3RyVGltZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaGVyPy5zdHJlYW1UaW1lID8/IDA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1pbGlzTGVmdCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy52aWRlb0luZm8ubWlsaXMgLSB0aGlzLnN0clRpbWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHRpbWVMZWZ0KCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgRGF0ZSh0aGlzLm1pbGlzTGVmdCkudG9JU09TdHJpbmcoKS5zbGljZSgxMSwgLTUpLnJlcGxhY2UoL14wKzo/MD8vZywgJycpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTXVzaWNRdWV1ZSB7XHJcbiAgICBwcml2YXRlIHRpbWVyPzogTm9kZUpTLlRpbWVvdXQ7XHJcbiAgICBxdWV1ZTogTXVzaWNFbnRyeVtdID0gW107XHJcbiAgICBoaXN0b3J5OiBNdXNpY0VudHJ5W10gPSBbXTtcclxuICAgIFZvaWNlQ29uOiBWb2ljZUNvbm5lY3Rpb247XHJcbiAgICBwbGF5aW5nOiBNdXNpY0VudHJ5IHwgbnVsbCA9IG51bGw7XHJcbiAgICBvdXRDaGFubmVsPzogVGV4dENoYW5uZWw7XHJcblxyXG4gICAgYWRkRW50cnkoZW50cnk6IE11c2ljRW50cnksIFZvaWNlQzogVm9pY2VDb25uZWN0aW9uLCB0b3A6IGJvb2xlYW4pIHtcclxuICAgICAgICB0aGlzLlZvaWNlQ29uID0gVm9pY2VDO1xyXG4gICAgICAgIGlmKHRvcClcclxuICAgICAgICAgICAgdGhpcy5xdWV1ZS51bnNoaWZ0KGVudHJ5KTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMucXVldWUucHVzaChlbnRyeSk7XHJcbiAgICAgICAgaWYoIXRoaXMucGxheWluZylcclxuICAgICAgICAgICAgdGhpcy5fcGxheU5leHQoKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlKCdhZGRlZFRvUXVldWUnLCBlbnRyeSk7XHJcbiAgICB9XHJcblxyXG4gICAgX3BsYXlOZXh0KCkge1xyXG4gICAgICAgIGlmKHRoaXMucXVldWUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBpZih0aGlzLnBsYXlpbmcpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpc3RvcnkucHVzaCh0aGlzLnBsYXlpbmcpO1xyXG4gICAgICAgICAgICB0aGlzLnBsYXlpbmcgPSB0aGlzLnF1ZXVlLnNoaWZ0KCkgYXMgTXVzaWNFbnRyeTtcclxuICAgICAgICAgICAgdGhpcy5wbGF5KHRoaXMucGxheWluZyk7XHJcbiAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlKCduZXh0U29uZycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuX2ZpbmlzaCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHBsYXkoZW50cnk6IE11c2ljRW50cnkpIHtcclxuICAgICAgICBpZih0aGlzLlZvaWNlQ29uLnN0YXR1cyAhPSAnMCcpIFxyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcignVm9pY2VDb25uZWN0aW9uIGlzIG5vdCByZWFkeScpO1xyXG4gICAgICAgIGxldCBzdHI7XHJcbiAgICAgICAgaWYoZW50cnkudHlwZSA9PSAneXQnKVxyXG4gICAgICAgICAgICBzdHIgPSBhd2FpdCBNb2trdW5NdXNpYy5nZXRZVFN0cmVhbShlbnRyeS52aWRlb0luZm8udXJsKTtcclxuICAgICAgICBlbHNlIGlmKGVudHJ5LnR5cGUgPT0gJ3NjJylcclxuICAgICAgICAgICAgc3RyID0gYXdhaXQgc2MuZG93bmxvYWQoKGVudHJ5LnZpZGVvSW5mbyBhcyBTb25nRW50cnkpLmlkKTtcclxuICAgICAgICAoPE5vZGVKUy5SZWFkYWJsZVN0cmVhbT4gc3RyKS5vbignZW5kJywgKCkgPT4gc2V0VGltZW91dCgoKSA9PiB0aGlzLl9wbGF5TmV4dCgpLCAyMDAwKSk7XHJcbiAgICAgICAgKDxNdXNpY0VudHJ5PiB0aGlzLnBsYXlpbmcpLmRpc3BhdGNoZXIgPSB0aGlzLlZvaWNlQ29uLnBsYXkoc3RyLCB7dHlwZTogJ29wdXMnLCBoaWdoV2F0ZXJNYXJrOiAxfSk7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5zZXRGRUModHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgX2ZpbmlzaCgpIHtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnBhdXNlPy4oKTtcclxuICAgICAgICBpZih0aGlzLnBsYXlpbmcpXHJcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5wdXNoKHRoaXMucGxheWluZyk7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nID0gbnVsbDtcclxuICAgICAgICB0aGlzLmRlc3RUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZighdGhpcy5wbGF5aW5nKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5Wb2ljZUNvbi5kaXNjb25uZWN0KCk7IFxyXG4gICAgICAgIH0sIDYwMDAwMCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGRlc3RUaW1lcih0aW1lcjogTm9kZUpTLlRpbWVvdXQpIHtcclxuICAgICAgICB0aGlzLnRpbWVyICYmIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTtcclxuICAgICAgICB0aGlzLnRpbWVyID0gdGltZXI7XHJcbiAgICB9XHJcblxyXG4gICAgX2Fubm91bmNlKHdoYXQ6ICduZXh0U29uZyd8J2FkZGVkVG9RdWV1ZSd8J3JlbW92ZWQnLCBlbnRyeT86IE11c2ljRW50cnksIHJldD86IGJvb2xlYW4pIDogdm9pZCB8IE1lc3NhZ2VFbWJlZCB7XHJcbiAgICAgICAgaWYoIXRoaXMub3V0Q2hhbm5lbClcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0Fubm91bmVtZW50IGNoYW5uZWwgaXMgbm90IHNwZWNpZmllZCcpO1xyXG4gICAgICAgIGxldCBlbWJlZCA9IG5ldyBNZXNzYWdlRW1iZWQoKS5zZXRDb2xvcihlbnRyeT8udHlwZSA9PSAnc2MnID8gJyNmZjg4MDAnIDogWzExMiwgMCwgNTVdKTtcclxuICAgICAgICBpZih3aGF0ID09ICduZXh0U29uZycpIHtcclxuICAgICAgICAgICAgbGV0IHBsID0gdGhpcy5wbGF5aW5nIGFzIE11c2ljRW50cnk7XHJcbiAgICAgICAgICAgIGVtYmVkLnNldEF1dGhvcignTmFzdMSZcG55IHV0d8OzciDwn461JylcclxuICAgICAgICAgICAgLnNldENvbG9yKHBsPy50eXBlID09ICdzYycgPyAnI2ZmODgwMCcgOiBbMTEyLCAwLCA1NV0pXHJcbiAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKipbJHtwbC52aWRlb0luZm8ubmFtZX1dKCR7cGwudmlkZW9JbmZvLnVybH0pKipgKVxyXG4gICAgICAgICAgICAuc2V0VGh1bWJuYWlsKHBsLnZpZGVvSW5mby50aHVtYm5haWwpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkthbmHFglwiLCBwbC52aWRlb0luZm8uYXV0aG9yLm5hbWUsIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkTFgnVnb8WbxIdcIiwgcGwudmlkZW9JbmZvLmR1cmF0aW9uLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJEb2Rhbm8gcHJ6ZXpcIiwgcGwuYWRkZWRCeS51c2VyLnVzZXJuYW1lLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJOYXN0xJlwbmllXCIsIHRoaXMucXVldWVbMF0/LnZpZGVvSW5mby5uYW1lID8/ICdicmFrJyk7XHJcbiAgICAgICAgfSBcclxuICAgICAgICBlbHNlIGlmKHdoYXQgPT0gJ2FkZGVkVG9RdWV1ZScpIHtcclxuICAgICAgICAgICAgbGV0IGVudHJ5IDogTXVzaWNFbnRyeSA9IGFyZ3VtZW50c1sxXTtcclxuICAgICAgICAgICAgZW1iZWQuc2V0QXV0aG9yKCdEb2Rhbm8gZG8ga29sZWpraScpXHJcbiAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKipbJHtlbnRyeS52aWRlb0luZm8ubmFtZX1dKCR7ZW50cnkudmlkZW9JbmZvLnVybH0pKipgKVxyXG4gICAgICAgICAgICAuc2V0VGh1bWJuYWlsKGVudHJ5LnZpZGVvSW5mby50aHVtYm5haWwpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkthbmHFglwiLCBlbnRyeS52aWRlb0luZm8uYXV0aG9yLm5hbWUsIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkTFgnVnb8WbxIdcIiwgZW50cnkudmlkZW9JbmZvLmR1cmF0aW9uLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJaYVwiLCB0aGlzLnRpbWVMZWZ0LCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJQb3p5Y2phXCIsIHRoaXMucXVldWUuZmluZEluZGV4KHYgPT4gdi5pZCA9PSBlbnRyeS5pZCkgKyAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZih3aGF0ID09ICdyZW1vdmVkJykge1xyXG4gICAgICAgICAgICBsZXQgZW50cnkgOiBNdXNpY0VudHJ5ID0gYXJndW1lbnRzWzFdO1xyXG4gICAgICAgICAgICBlbWJlZC5zZXRBdXRob3IoJ1VzdW5pxJl0byB6IGtvbGVqa2knKVxyXG4gICAgICAgICAgICAuc2V0RGVzY3JpcHRpb24oYCoqWyR7ZW50cnkudmlkZW9JbmZvLm5hbWV9XSgke2VudHJ5LnZpZGVvSW5mby51cmx9KSoqYClcclxuICAgICAgICAgICAgLnNldFRodW1ibmFpbChlbnRyeS52aWRlb0luZm8udGh1bWJuYWlsKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZihyZXQpXHJcbiAgICAgICAgICAgIHJldHVybiBlbWJlZDtcclxuICAgICAgICB0aGlzLm91dENoYW5uZWwuc2VuZChlbWJlZCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1pbGlzTGVmdCgpIHtcclxuICAgICAgICBsZXQgbGVuID0gKHRoaXMucGxheWluZz8udmlkZW9JbmZvLm1pbGlzIHx8IDApIC0gKHRoaXMucGxheWluZz8uc3RyVGltZSB8fCAwKTtcclxuICAgICAgICBmb3IobGV0IGVudCBvZiB0aGlzLnF1ZXVlLnNsaWNlKDAsIC0xKSlcclxuICAgICAgICAgICAgbGVuICs9IGVudC52aWRlb0luZm8ubWlsaXM7XHJcbiAgICAgICAgcmV0dXJuIGxlbjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZUxlZnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMubWlsaXNMZWZ0KS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAtNSkucmVwbGFjZSgvXjArOj8wPy9nLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcGF1c2UoKSB7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3VtZSgpIHtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnJlc3VtZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZShwb3M6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgICAgICBpZighKC9eWzEtOV1cXGQqJC8pLnRlc3QocG9zKSB8fCAhdGhpcy5xdWV1ZVsrcG9zLTFdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fYW5ub3VuY2UoJ3JlbW92ZWQnLCB0aGlzLnF1ZXVlLnNwbGljZSgrcG9zLTEsIDEpWzBdKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRPdXRDaGFuKGNoYW46IFRleHRDaGFubmVsKSA6IE11c2ljUXVldWUge1xyXG4gICAgICAgIHRoaXMub3V0Q2hhbm5lbCA9IGNoYW47XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHN0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZWQgPyAncGF1c2VkJyA6IHRoaXMucGxheWluZz8uZGlzcGF0Y2hlciA/ICdwbGF5aW5nJyA6ICdpZGxlJztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE1va2t1bk11c2ljIHtcclxuICAgIHByaXZhdGUgcXVldWVzID0gbmV3IENvbGxlY3Rpb248c3RyaW5nLCBNdXNpY1F1ZXVlPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHNjLnNldENsaWVudElkKHByb2Nlc3MuZW52LlNDX0NMSUVOVF9JRCBhcyBzdHJpbmcpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFF1ZXVlKGd1aWxkOiBHdWlsZCkgOiBNdXNpY1F1ZXVlIHtcclxuICAgICAgICBsZXQgcSA9IHRoaXMucXVldWVzLmdldChndWlsZC5pZCk7XHJcbiAgICAgICAgaWYoIXEpIHtcclxuICAgICAgICAgICAgcSA9IG5ldyBNdXNpY1F1ZXVlKCk7XHJcbiAgICAgICAgICAgIHRoaXMucXVldWVzLnNldChndWlsZC5pZCwgcSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxO1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaFZpZGVvcyhxdWVyeTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHl0cyhxdWVyeSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoU0MocXVlcnk6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBzYy5zZWFyY2gocXVlcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBnZXRZVFN0cmVhbSh1cmw6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB5dGRsKHVybCwge3F1YWxpdHk6ICdoaWdoZXN0YXVkaW8nLCBoaWdoV2F0ZXJNYXJrOiAxPDwyNX0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlc3Ryb3lRdWV1ZShndWlsZGlkOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLnF1ZXVlcy5kZWxldGUoZ3VpbGRpZCk7XHJcbiAgICB9IFxyXG59Il19