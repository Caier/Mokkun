"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_js_1 = require("discord.js");
const ytdl_core_discord_1 = __importDefault(require("ytdl-core-discord"));
const yts_1 = __importDefault(require("@caier/yts"));
const v4_1 = __importDefault(require("uuid/v4"));
class MusicEntry {
    constructor(opts) {
        this.id = v4_1.default();
        this.addedOn = Date.now();
        this.addedBy = opts.member;
        this.queue = opts.queue;
        this.type = opts.type;
        this.videoInfo = opts.vid;
    }
    get strTime() {
        var _a, _b;
        return (_b = (_a = this.dispatcher) === null || _a === void 0 ? void 0 : _a.streamTime) !== null && _b !== void 0 ? _b : 0;
    }
    get milisLeft() {
        return this.videoInfo.milis - this.strTime;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
}
exports.MusicEntry = MusicEntry;
class MusicQueue {
    constructor() {
        this.queue = [];
        this.history = [];
        this.playing = null;
    }
    addEntry(entry, VoiceC) {
        this.VoiceCon = VoiceC;
        this.queue.push(entry);
        if (!this.playing)
            this._playNext();
        else
            this._announce('addedToQueue', this.queue[this.queue.length - 1]);
    }
    _playNext() {
        if (this.queue.length > 0) {
            if (this.playing)
                this.history.push(this.playing);
            this.playing = this.queue.shift();
            this.play(this.playing);
            this._announce('nextSong');
        }
        else
            this._finish();
    }
    async play(entry) {
        var _a, _b;
        if (this.VoiceCon.status != '0')
            throw Error('VoiceConnection is not ready');
        let str;
        if (entry.type == 'yt') {
            str = await MokkunMusic.getYTStream(entry.videoInfo.url);
            str.on('end', () => setTimeout(() => this._playNext(), 2000) && console.log('stream closed'));
        }
        this.playing.dispatcher = this.VoiceCon.play(str, { type: 'opus' });
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.setFEC(true);
    }
    _finish() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause) === null || _c === void 0 ? void 0 : _c.call(_b);
        if (this.playing)
            this.history.push(this.playing);
        this.playing = null;
        this.destTimer = setTimeout(() => {
            if (!this.playing)
                this.VoiceCon.disconnect();
        }, 600000);
    }
    set destTimer(timer) {
        this.timer && clearTimeout(this.timer);
        this.timer = timer;
    }
    _announce(what, entry, ret) {
        var _a, _b;
        if (!this.outChannel)
            throw Error('Announement channel is not specified');
        let embed = new discord_js_1.MessageEmbed().setColor([112, 0, 55]);
        if (what == 'nextSong') {
            let pl = this.playing;
            embed.setAuthor('NastÄ™pny utwÃ³r ðŸŽµ')
                .setDescription(`**[${pl.videoInfo.name}](${pl.videoInfo.url})**`)
                .setThumbnail(pl.videoInfo.thumbnail)
                .addField("KanaÅ‚", pl.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", pl.videoInfo.duration, true)
                .addField("Dodano przez", pl.addedBy.user.username, true)
                .addField("NastÄ™pnie", (_b = (_a = this.queue[0]) === null || _a === void 0 ? void 0 : _a.videoInfo.name) !== null && _b !== void 0 ? _b : 'brak');
        }
        else if (what == 'addedToQueue') {
            let entry = arguments[1];
            embed.setAuthor('Dodano do kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail)
                .addField("KanaÅ‚", entry.videoInfo.author.name, true)
                .addField("DÅ‚ugoÅ›Ä‡", entry.videoInfo.duration, true)
                .addField("Za", this.timeLeft, true)
                .addField("Pozycja", this.queue.length);
        }
        else if (what == 'removed') {
            let entry = arguments[1];
            embed.setAuthor('UsuniÄ™to z kolejki')
                .setDescription(`**[${entry.videoInfo.name}](${entry.videoInfo.url})**`)
                .setThumbnail(entry.videoInfo.thumbnail);
        }
        if (ret)
            return embed;
        this.outChannel.send(embed);
    }
    get milisLeft() {
        var _a, _b;
        let len = (((_a = this.playing) === null || _a === void 0 ? void 0 : _a.videoInfo.milis) || 0) - (((_b = this.playing) === null || _b === void 0 ? void 0 : _b.strTime) || 0);
        for (let ent of this.queue.slice(0, -1))
            len += ent.videoInfo.milis;
        return len;
    }
    get timeLeft() {
        return new Date(this.milisLeft).toISOString().slice(11, -5).replace(/^0+:?0?/g, '');
    }
    pause() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.pause();
    }
    resume() {
        var _a, _b;
        (_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.resume();
    }
    remove(pos) {
        if (!(/^[1-9]\d*$/).test(pos) || !this.queue[+pos - 1]) {
            return false;
        }
        this._announce('removed', this.queue.splice(+pos - 1, 1)[0]);
        return true;
    }
    setOutChan(chan) {
        this.outChannel = chan;
        return this;
    }
    get status() {
        var _a, _b, _c;
        return ((_b = (_a = this.playing) === null || _a === void 0 ? void 0 : _a.dispatcher) === null || _b === void 0 ? void 0 : _b.paused) ? 'paused' : ((_c = this.playing) === null || _c === void 0 ? void 0 : _c.dispatcher) ? 'playing' : 'idle';
    }
}
exports.MusicQueue = MusicQueue;
class MokkunMusic {
    constructor() {
        this.queues = new discord_js_1.Collection();
    }
    getQueue(guild) {
        let q = this.queues.get(guild.id);
        if (!q) {
            q = new MusicQueue();
            this.queues.set(guild.id, q);
        }
        return q;
    }
    searchVideos(query) {
        return yts_1.default(query);
    }
    static getYTStream(url) {
        return ytdl_core_discord_1.default(url, { quality: 'highestaudio', highWaterMark: 1 << 25 });
    }
    destroyQueue(guildid) {
        this.queues.delete(guildid);
    }
}
exports.MokkunMusic = MokkunMusic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9ra3VuTXVzaWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvTW9ra3VuTXVzaWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FBeUc7QUFHekcsMEVBQXFDO0FBQ3JDLHFEQUE2QjtBQUU3QixpREFBMkI7QUFFM0IsTUFBYSxVQUFVO0lBU25CLFlBQVksSUFBZ0Y7UUFSNUYsT0FBRSxHQUFXLFlBQUksRUFBRSxDQUFDO1FBQ3BCLFlBQU8sR0FBVyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFRekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQzlCLENBQUM7SUFFRCxJQUFJLE9BQU87O1FBQ1AsbUJBQU8sSUFBSSxDQUFDLFVBQVUsMENBQUUsVUFBVSxtQ0FBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELElBQUksU0FBUztRQUNULE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUMvQyxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1IsT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEYsQ0FBQztDQUNKO0FBM0JELGdDQTJCQztBQUVELE1BQWEsVUFBVTtJQUF2QjtRQUVJLFVBQUssR0FBaUIsRUFBRSxDQUFDO1FBQ3pCLFlBQU8sR0FBaUIsRUFBRSxDQUFDO1FBRTNCLFlB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RSxVQUFVLDBDQUFFLE1BQU0sRUFBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLFVBQVUsRUFBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkcsQ0FBQztDQUNKO0FBL0hELGdDQStIQztBQUVELE1BQWEsV0FBVztJQUF4QjtRQUNZLFdBQU0sR0FBRyxJQUFJLHVCQUFVLEVBQXNCLENBQUM7SUFzQjFELENBQUM7SUFwQkcsUUFBUSxDQUFDLEtBQVk7UUFDakIsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLElBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDSCxDQUFDLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2hDO1FBQ0QsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQWE7UUFDdEIsT0FBTyxhQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBVztRQUMxQixPQUFPLDJCQUFJLENBQUMsR0FBRyxFQUFFLEVBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsQ0FBQyxJQUFFLEVBQUUsRUFBQyxDQUFDLENBQUM7SUFDdEUsQ0FBQztJQUVELFlBQVksQ0FBQyxPQUFlO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDSjtBQXZCRCxrQ0F1QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2xsZWN0aW9uLCBUZXh0Q2hhbm5lbCwgTWVzc2FnZUVtYmVkLCBHdWlsZCwgR3VpbGRNZW1iZXIsIFN0cmVhbURpc3BhdGNoZXIgfSBmcm9tICdkaXNjb3JkLmpzJztcclxuLy8gQHRzLWlnbm9yZVxyXG5pbXBvcnQgVm9pY2VDb25uZWN0aW9uIGZyb20gJ2Rpc2NvcmQuanMvc3JjL2NsaWVudC92b2ljZS9Wb2ljZUNvbm5lY3Rpb24nO1xyXG5pbXBvcnQgeXRkbCBmcm9tICd5dGRsLWNvcmUtZGlzY29yZCc7XHJcbmltcG9ydCB5dHMgZnJvbSAnQGNhaWVyL3l0cyc7XHJcbmltcG9ydCB7IFZpZGVvRW50cnkgfSBmcm9tICdAY2FpZXIveXRzL2xpYi9pbnRlcmZhY2VzJztcclxuaW1wb3J0IHV1aWQgZnJvbSAndXVpZC92NCc7XHJcblxyXG5leHBvcnQgY2xhc3MgTXVzaWNFbnRyeSB7XHJcbiAgICBpZDogc3RyaW5nID0gdXVpZCgpO1xyXG4gICAgYWRkZWRPbjogbnVtYmVyID0gRGF0ZS5ub3coKTtcclxuICAgIGFkZGVkQnk6IEd1aWxkTWVtYmVyO1xyXG4gICAgcXVldWU6IE11c2ljUXVldWU7XHJcbiAgICB0eXBlOiBcInl0XCJ8XCJzY1wiO1xyXG4gICAgdmlkZW9JbmZvOiBWaWRlb0VudHJ5O1xyXG4gICAgZGlzcGF0Y2hlcj86IFN0cmVhbURpc3BhdGNoZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0czoge3ZpZDogVmlkZW9FbnRyeSwgbWVtYmVyOiBHdWlsZE1lbWJlciwgcXVldWU6IE11c2ljUXVldWUsIHR5cGU6IFwieXRcInxcInNjXCJ9KSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZEJ5ID0gb3B0cy5tZW1iZXI7XHJcbiAgICAgICAgdGhpcy5xdWV1ZSA9IG9wdHMucXVldWU7XHJcbiAgICAgICAgdGhpcy50eXBlID0gb3B0cy50eXBlO1xyXG4gICAgICAgIHRoaXMudmlkZW9JbmZvID0gb3B0cy52aWQ7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldCBzdHJUaW1lKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXI/LnN0cmVhbVRpbWUgPz8gMDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWlsaXNMZWZ0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnZpZGVvSW5mby5taWxpcyAtIHRoaXMuc3RyVGltZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZUxlZnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMubWlsaXNMZWZ0KS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAtNSkucmVwbGFjZSgvXjArOj8wPy9nLCAnJyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBNdXNpY1F1ZXVlIHtcclxuICAgIHByaXZhdGUgdGltZXI/OiBOb2RlSlMuVGltZW91dDtcclxuICAgIHF1ZXVlOiBNdXNpY0VudHJ5W10gPSBbXTtcclxuICAgIGhpc3Rvcnk6IE11c2ljRW50cnlbXSA9IFtdO1xyXG4gICAgVm9pY2VDb246IFZvaWNlQ29ubmVjdGlvbjtcclxuICAgIHBsYXlpbmc6IE11c2ljRW50cnkgfCBudWxsID0gbnVsbDtcclxuICAgIG91dENoYW5uZWw/OiBUZXh0Q2hhbm5lbDtcclxuXHJcbiAgICBhZGRFbnRyeShlbnRyeTogTXVzaWNFbnRyeSwgVm9pY2VDOiBWb2ljZUNvbm5lY3Rpb24pIHtcclxuICAgICAgICB0aGlzLlZvaWNlQ29uID0gVm9pY2VDO1xyXG4gICAgICAgIHRoaXMucXVldWUucHVzaChlbnRyeSk7XHJcbiAgICAgICAgaWYoIXRoaXMucGxheWluZylcclxuICAgICAgICAgICAgdGhpcy5fcGxheU5leHQoKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuX2Fubm91bmNlKCdhZGRlZFRvUXVldWUnLCB0aGlzLnF1ZXVlW3RoaXMucXVldWUubGVuZ3RoIC0gMV0pO1xyXG4gICAgfVxyXG5cclxuICAgIF9wbGF5TmV4dCgpIHtcclxuICAgICAgICBpZih0aGlzLnF1ZXVlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYodGhpcy5wbGF5aW5nKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnB1c2godGhpcy5wbGF5aW5nKTtcclxuICAgICAgICAgICAgdGhpcy5wbGF5aW5nID0gdGhpcy5xdWV1ZS5zaGlmdCgpIGFzIE11c2ljRW50cnk7XHJcbiAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLnBsYXlpbmcpO1xyXG4gICAgICAgICAgICB0aGlzLl9hbm5vdW5jZSgnbmV4dFNvbmcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB0aGlzLl9maW5pc2goKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBwbGF5KGVudHJ5OiBNdXNpY0VudHJ5KSB7XHJcbiAgICAgICAgaWYodGhpcy5Wb2ljZUNvbi5zdGF0dXMgIT0gJzAnKSBcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ1ZvaWNlQ29ubmVjdGlvbiBpcyBub3QgcmVhZHknKTtcclxuICAgICAgICBsZXQgc3RyO1xyXG4gICAgICAgIGlmKGVudHJ5LnR5cGUgPT0gJ3l0Jykge1xyXG4gICAgICAgICAgICBzdHIgPSBhd2FpdCBNb2trdW5NdXNpYy5nZXRZVFN0cmVhbShlbnRyeS52aWRlb0luZm8udXJsKTtcclxuICAgICAgICAgICAgc3RyLm9uKCdlbmQnLCAoKSA9PiBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3BsYXlOZXh0KCksIDIwMDApICYmIGNvbnNvbGUubG9nKCdzdHJlYW0gY2xvc2VkJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAoPE11c2ljRW50cnk+IHRoaXMucGxheWluZykuZGlzcGF0Y2hlciA9IHRoaXMuVm9pY2VDb24ucGxheShzdHIsIHt0eXBlOiAnb3B1cyd9KTtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnNldEZFQyh0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBfZmluaXNoKCkge1xyXG4gICAgICAgIHRoaXMucGxheWluZz8uZGlzcGF0Y2hlcj8ucGF1c2U/LigpO1xyXG4gICAgICAgIGlmKHRoaXMucGxheWluZylcclxuICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnB1c2godGhpcy5wbGF5aW5nKTtcclxuICAgICAgICB0aGlzLnBsYXlpbmcgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuZGVzdFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKCF0aGlzLnBsYXlpbmcpXHJcbiAgICAgICAgICAgICAgICB0aGlzLlZvaWNlQ29uLmRpc2Nvbm5lY3QoKTsgXHJcbiAgICAgICAgfSwgNjAwMDAwKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZGVzdFRpbWVyKHRpbWVyOiBOb2RlSlMuVGltZW91dCkge1xyXG4gICAgICAgIHRoaXMudGltZXIgJiYgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpO1xyXG4gICAgICAgIHRoaXMudGltZXIgPSB0aW1lcjtcclxuICAgIH1cclxuXHJcbiAgICBfYW5ub3VuY2Uod2hhdDogJ25leHRTb25nJ3wnYWRkZWRUb1F1ZXVlJ3wncmVtb3ZlZCcsIGVudHJ5PzogTXVzaWNFbnRyeSwgcmV0PzogYm9vbGVhbikgOiB2b2lkIHwgTWVzc2FnZUVtYmVkIHtcclxuICAgICAgICBpZighdGhpcy5vdXRDaGFubmVsKVxyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcignQW5ub3VuZW1lbnQgY2hhbm5lbCBpcyBub3Qgc3BlY2lmaWVkJyk7XHJcbiAgICAgICAgbGV0IGVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpLnNldENvbG9yKFsxMTIsIDAsIDU1XSk7XHJcbiAgICAgICAgaWYod2hhdCA9PSAnbmV4dFNvbmcnKSB7XHJcbiAgICAgICAgICAgIGxldCBwbCA9IHRoaXMucGxheWluZyBhcyBNdXNpY0VudHJ5O1xyXG4gICAgICAgICAgICBlbWJlZC5zZXRBdXRob3IoJ05hc3TEmXBueSB1dHfDs3Ig8J+OtScpXHJcbiAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKipbJHtwbC52aWRlb0luZm8ubmFtZX1dKCR7cGwudmlkZW9JbmZvLnVybH0pKipgKVxyXG4gICAgICAgICAgICAuc2V0VGh1bWJuYWlsKHBsLnZpZGVvSW5mby50aHVtYm5haWwpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkthbmHFglwiLCBwbC52aWRlb0luZm8uYXV0aG9yLm5hbWUsIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkTFgnVnb8WbxIdcIiwgcGwudmlkZW9JbmZvLmR1cmF0aW9uLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJEb2Rhbm8gcHJ6ZXpcIiwgcGwuYWRkZWRCeS51c2VyLnVzZXJuYW1lLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJOYXN0xJlwbmllXCIsIHRoaXMucXVldWVbMF0/LnZpZGVvSW5mby5uYW1lID8/ICdicmFrJyk7XHJcbiAgICAgICAgfSBcclxuICAgICAgICBlbHNlIGlmKHdoYXQgPT0gJ2FkZGVkVG9RdWV1ZScpIHtcclxuICAgICAgICAgICAgbGV0IGVudHJ5IDogTXVzaWNFbnRyeSA9IGFyZ3VtZW50c1sxXTtcclxuICAgICAgICAgICAgZW1iZWQuc2V0QXV0aG9yKCdEb2Rhbm8gZG8ga29sZWpraScpXHJcbiAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihgKipbJHtlbnRyeS52aWRlb0luZm8ubmFtZX1dKCR7ZW50cnkudmlkZW9JbmZvLnVybH0pKipgKVxyXG4gICAgICAgICAgICAuc2V0VGh1bWJuYWlsKGVudHJ5LnZpZGVvSW5mby50aHVtYm5haWwpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkthbmHFglwiLCBlbnRyeS52aWRlb0luZm8uYXV0aG9yLm5hbWUsIHRydWUpXHJcbiAgICAgICAgICAgIC5hZGRGaWVsZChcIkTFgnVnb8WbxIdcIiwgZW50cnkudmlkZW9JbmZvLmR1cmF0aW9uLCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJaYVwiLCB0aGlzLnRpbWVMZWZ0LCB0cnVlKVxyXG4gICAgICAgICAgICAuYWRkRmllbGQoXCJQb3p5Y2phXCIsIHRoaXMucXVldWUubGVuZ3RoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZih3aGF0ID09ICdyZW1vdmVkJykge1xyXG4gICAgICAgICAgICBsZXQgZW50cnkgOiBNdXNpY0VudHJ5ID0gYXJndW1lbnRzWzFdO1xyXG4gICAgICAgICAgICBlbWJlZC5zZXRBdXRob3IoJ1VzdW5pxJl0byB6IGtvbGVqa2knKVxyXG4gICAgICAgICAgICAuc2V0RGVzY3JpcHRpb24oYCoqWyR7ZW50cnkudmlkZW9JbmZvLm5hbWV9XSgke2VudHJ5LnZpZGVvSW5mby51cmx9KSoqYClcclxuICAgICAgICAgICAgLnNldFRodW1ibmFpbChlbnRyeS52aWRlb0luZm8udGh1bWJuYWlsKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZihyZXQpXHJcbiAgICAgICAgICAgIHJldHVybiBlbWJlZDtcclxuICAgICAgICB0aGlzLm91dENoYW5uZWwuc2VuZChlbWJlZCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG1pbGlzTGVmdCgpIHtcclxuICAgICAgICBsZXQgbGVuID0gKHRoaXMucGxheWluZz8udmlkZW9JbmZvLm1pbGlzIHx8IDApIC0gKHRoaXMucGxheWluZz8uc3RyVGltZSB8fCAwKTtcclxuICAgICAgICBmb3IobGV0IGVudCBvZiB0aGlzLnF1ZXVlLnNsaWNlKDAsIC0xKSlcclxuICAgICAgICAgICAgbGVuICs9IGVudC52aWRlb0luZm8ubWlsaXM7XHJcbiAgICAgICAgcmV0dXJuIGxlbjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZUxlZnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMubWlsaXNMZWZ0KS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAtNSkucmVwbGFjZSgvXjArOj8wPy9nLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcGF1c2UoKSB7XHJcbiAgICAgICAgdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3VtZSgpIHtcclxuICAgICAgICB0aGlzLnBsYXlpbmc/LmRpc3BhdGNoZXI/LnJlc3VtZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZShwb3M6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgICAgICBpZighKC9eWzEtOV1cXGQqJC8pLnRlc3QocG9zKSB8fCAhdGhpcy5xdWV1ZVsrcG9zLTFdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fYW5ub3VuY2UoJ3JlbW92ZWQnLCB0aGlzLnF1ZXVlLnNwbGljZSgrcG9zLTEsIDEpWzBdKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRPdXRDaGFuKGNoYW46IFRleHRDaGFubmVsKSA6IE11c2ljUXVldWUge1xyXG4gICAgICAgIHRoaXMub3V0Q2hhbm5lbCA9IGNoYW47XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHN0YXR1cygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF5aW5nPy5kaXNwYXRjaGVyPy5wYXVzZWQgPyAncGF1c2VkJyA6IHRoaXMucGxheWluZz8uZGlzcGF0Y2hlciA/ICdwbGF5aW5nJyA6ICdpZGxlJztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE1va2t1bk11c2ljIHtcclxuICAgIHByaXZhdGUgcXVldWVzID0gbmV3IENvbGxlY3Rpb248c3RyaW5nLCBNdXNpY1F1ZXVlPigpO1xyXG5cclxuICAgIGdldFF1ZXVlKGd1aWxkOiBHdWlsZCkgOiBNdXNpY1F1ZXVlIHtcclxuICAgICAgICBsZXQgcSA9IHRoaXMucXVldWVzLmdldChndWlsZC5pZCk7XHJcbiAgICAgICAgaWYoIXEpIHtcclxuICAgICAgICAgICAgcSA9IG5ldyBNdXNpY1F1ZXVlKCk7XHJcbiAgICAgICAgICAgIHRoaXMucXVldWVzLnNldChndWlsZC5pZCwgcSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxO1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaFZpZGVvcyhxdWVyeTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHl0cyhxdWVyeSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGdldFlUU3RyZWFtKHVybDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHl0ZGwodXJsLCB7cXVhbGl0eTogJ2hpZ2hlc3RhdWRpbycsIGhpZ2hXYXRlck1hcms6IDE8PDI1fSk7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveVF1ZXVlKGd1aWxkaWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMucXVldWVzLmRlbGV0ZShndWlsZGlkKTtcclxuICAgIH0gXHJcbn0iXX0=